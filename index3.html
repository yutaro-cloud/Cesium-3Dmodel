<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>g3Dmap on Cesium</title>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.63.1/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.63.1/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

<style>
  #cesiumContainer {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    margin: 0;
    overflow: hidden;
    padding: 0;
    font-family: sans-serif;
  }
  html {
    height: 100%;
  }
  body {
    padding: 0;
    margin: 0;
    overflow: hidden;
    height: 100%;
  }
</style>
</head>

<body>
<div id="cesiumContainer"></div>

  
  <script>
  //**
(function(){
    var
        Credit = Cesium.Credit,
        defaultValue = Cesium.defaultValue,
        defined = Cesium.defined,
        defineProperties = Cesium.defineProperties,
        DeveloperError = Cesium.DeveloperError,
        Event = Cesium.Event,
        Rectangle = Cesium.Rectangle,
        WebMercatorTilingScheme = Cesium.WebMercatorTilingScheme,
        ImageryProvider = Cesium.ImageryProvider;
    /**/

    "use strict";

    var trailingSlashRegex = /\/$/;
    var zoomStringRegex = /^([0-9]+)-?([0-9]+)?$/;
    var defaultCredit = new Credit('国土地理院');

    var defaultLayerIDs = {
        "std": {
            "id": "std",
            "name": "標準地図",
            "ext": "png",
            "zoom": "0-18"
        },
        "pale": {
            "id": "pale",
            "name": "淡色地図",
            "ext": "png",
            "zoom": "12-18"
        },
        "blank": {
            "id": "blank",
            "name": "白地図",
            "ext": "png",
            "zoom": "5-14"
        },
        "english": {
            "id": "english",
            "name": "Romanized",
            "ext": "png",
            "zoom": "5-11"
        },
        "relief": {
            "id": "relief",
            "name": "色別標高図",
            "ext": "png",
            "zoom": "5-15"
        },
        "ort": {
            "id": "ort",
            "name": "電子国土基本図（オルソ画像）",
            "ext": "jpg",
            "zoom": "15-17"
        },
        "gazo1": {
            "id": "gazo1",
            "name": "国土画像情報（第一期：1974～1978年撮影）",
            "ext": "jpg",
            "zoom": "15-17"
        },
        "gazo2": {
            "id": "gazo2",
            "name": "国土画像情報（第二期：1979～1983年撮影）",
            "ext": "jpg",
            "zoom": "15-17"
        },
        "gazo3": {
            "id": "gazo3",
            "name": "国土画像情報（第三期：1984～1986年撮影）",
            "ext": "jpg",
            "zoom": "15-17"
        },
        "gazo4": {
            "id": "gazo4",
            "name": "国土画像情報（第四期：1988～1990年撮影）",
            "ext": "jpg",
            "zoom": "15-17"
        },
        "airphoto": {
            "id": "airphoto",
            "name": "簡易空中写真（2004年～）",
            "ext": "png",
            "zoom": "15-18"
        }
    };

    function devideZoomString(zoomString) {
        if (zoomString.match(zoomStringRegex)) {
            var min = RegExp.$1;
            var max = RegExp.$2;
            return max ? [parseInt(min),parseInt(max)] : [parseInt(min),parseInt(min)];
        }
        return [];
    }

    function parseLayers(optionLayerList) {
        if (!optionLayerList) {
            optionLayerList = ["std"];
        }
        var layerList = [], max = 0, min = 18;

        for (var i = 0; i < optionLayerList.length; i++) {
            var optionLayer = optionLayerList[i];
            var isStr = typeof optionLayer === "string";
            if (isStr) {
                optionLayer = defaultLayerIDs[optionLayer];
            } else {
                var defaultLayer = defaultLayerIDs[optionLayer.id];
                if (defaultLayer) {
                    optionLayer.ext = defaultValue(optionLayer.ext, defaultLayer.ext);
                    optionLayer.zoom = defaultValue(optionLayer.zoom, defaultLayer.zoom);
                }
            }

            var minmax = devideZoomString(optionLayer.zoom);
            if (minmax.length == 0) continue;
            if (minmax[0] < min) min = minmax[0];
            if (minmax[1] > max) max = minmax[1];

            for (var j=minmax[0];j<=minmax[1];j++) {
                if (!layerList[j]) layerList[j] = optionLayer;
            }
        }

        for (var i=min;i<=max;i++) {
            if (!layerList[i]) throw "No layer definition for zoom level" + i;
        }
        if (max < min) throw "There are no valid layer definition";

        return [layerList, min, max];
    }

    var JapanGSIImageryProvider = function JapanGSIImageryProvider(options) {
        options = defaultValue(options, {});

        var url = defaultValue(options.url, '//a.tile.openstreetmap.org/');

        if (!trailingSlashRegex.test(url)) {
            url = url + '/';
        }

        this._url = url;
        this._fileExtension = defaultValue(options.fileExtension, 'png');
        this._proxy = options.proxy;
        this._tileDiscardPolicy = options.tileDiscardPolicy;

        this._tilingScheme = new WebMercatorTilingScheme();

        this._tileWidth = 256;
        this._tileHeight = 256;

        var parsedLayers = parseLayers(options.layerLists);
        this._layerLists = parsedLayers[0];

        this._minimumLevel = defaultValue(options.minimumLevel, parsedLayers[1]);
        this._maximumLevel = defaultValue(options.maximumLevel, parsedLayers[2]);

        this._rectangle = defaultValue(options.rectangle, this._tilingScheme.rectangle);

        // Check the number of tiles at the minimum level.  If it's more than four,
        // throw an exception, because starting at the higher minimum
        // level will cause too many tiles to be downloaded and rendered.
        var swTile = this._tilingScheme.positionToTileXY(Rectangle.southwest(this._rectangle), this._minimumLevel);
        var neTile = this._tilingScheme.positionToTileXY(Rectangle.northeast(this._rectangle), this._minimumLevel);
        var tileCount = (Math.abs(neTile.x - swTile.x) + 1) * (Math.abs(neTile.y - swTile.y) + 1);
        if (tileCount > 4) {
            throw new DeveloperError('The imagery provider\'s rectangle and minimumLevel indicate that there are ' + tileCount + ' tiles at the minimum level. Imagery providers with more than four tiles at the minimum level are not supported.');
        }

        this._errorEvent = new Event();

        this._ready = true;

        var credit = defaultValue(options.credit, defaultCredit);
        if (typeof credit === 'string') {
            credit = new Credit(credit);
        }
        this._credit = credit;
    };

    function buildImageUrl(imageryProvider, x, y, level) {
        var url;
        if (imageryProvider._layerLists[level]) {
            var layer = imageryProvider._layerLists[level];
            url = "//cyberjapandata.gsi.go.jp/xyz/" + layer.id + "/" + level + "/" + x + "/" + y + "." + layer.ext;
        } else {
            url = imageryProvider._url + level + '/' + x + '/' + y + '.' + imageryProvider._fileExtension;
        }

        var proxy = imageryProvider._proxy;
        if (defined(proxy)) {
            url = proxy.getURL(url);
        }

        return url;
    }

    defineProperties(JapanGSIImageryProvider.prototype, {
        url : {
            get : function() {
                return this._url;
            }
        },

        proxy : {
            get : function() {
                return this._proxy;
            }
        },

        tileWidth : {
            get : function() {
                if (!this._ready) {
                    throw new DeveloperError('tileWidth must not be called before the imagery provider is ready.');
                }

                return this._tileWidth;
            }
        },

        tileHeight: {
            get : function() {
                if (!this._ready) {
                    throw new DeveloperError('tileHeight must not be called before the imagery provider is ready.');
                }

                return this._tileHeight;
            }
        },

        maximumLevel : {
            get : function() {
                if (!this._ready) {
                    throw new DeveloperError('maximumLevel must not be called before the imagery provider is ready.');
                }

                return this._maximumLevel;
            }
        },

        minimumLevel : {
            get : function() {
                if (!this._ready) {
                    throw new DeveloperError('minimumLevel must not be called before the imagery provider is ready.');
                }

                return this._minimumLevel;
            }
        },

        tilingScheme : {
            get : function() {
                if (!this._ready) {
                    throw new DeveloperError('tilingScheme must not be called before the imagery provider is ready.');
                }

                return this._tilingScheme;
            }
        },

        rectangle : {
            get : function() {
                if (!this._ready) {
                    throw new DeveloperError('rectangle must not be called before the imagery provider is ready.');
                }

                return this._rectangle;
            }
        },

        tileDiscardPolicy : {
            get : function() {
                if (!this._ready) {
                    throw new DeveloperError('tileDiscardPolicy must not be called before the imagery provider is ready.');
                }

                return this._tileDiscardPolicy;
            }
        },

        errorEvent : {
            get : function() {
                return this._errorEvent;
            }
        },

        ready : {
            get : function() {
                return this._ready;
            }
        },

        credit : {
            get : function() {
                return this._credit;
            }
        },

        hasAlphaChannel : {
            get : function() {
                return true;
            }
        }
    });

    JapanGSIImageryProvider.prototype.getTileCredits = function(x, y, level) {
        return undefined;
    };

    JapanGSIImageryProvider.prototype.requestImage = function(x, y, level) {
        if (!this._ready) {
            throw new DeveloperError('requestImage must not be called before the imagery provider is ready.');
        }

        var url = buildImageUrl(this, x, y, level);
        return ImageryProvider.loadImage(this, url);
    };

    JapanGSIImageryProvider.prototype.pickFeatures = function() {
        return undefined;
    };

    Cesium.JapanGSIImageryProvider = JapanGSIImageryProvider;
})();
  </script>
  
  
  <script>
  //**
(function(){
var
    defaultValue = Cesium.defaultValue,
    defined = Cesium.defined,
    defineProperties = Cesium.defineProperties,
    loadText = Cesium.loadText,
    loadImage = Cesium.loadImage,
    throttleRequestByServer = Cesium.throttleRequestByServer,
    Event = Cesium.Event,
    Credit = Cesium.Credit,
    WebMercatorTilingScheme = Cesium.WebMercatorTilingScheme,
    HeightmapTerrainData = Cesium.HeightmapTerrainData,
    TerrainProvider = Cesium.TerrainProvider,
    when = Cesium.when;
/**/
    "use strict";

    var trailingSlashRegex = /\/$/;
    var defaultCredit = new Credit('国土地理院');
    var GSI_MAX_TERRAIN_LEVEL = 15;

    var JapanGSITerrainProvider = function JapanGSITerrainProvider(options) {
        options = defaultValue(options, {});

        this._usePngData = defaultValue(options.usePngData,true);
        var url;
        if ( this._usePngData ){
            url = defaultValue(options.url, 'https://cyberjapandata.gsi.go.jp/xyz/dem_png'); // use https to disable google chrome's data saver for prevent bluring imagg.
            this._loadDataFunction = loadImage;
        } else {
            url  = defaultValue(options.url, '//cyberjapandata.gsi.go.jp/xyz/dem');
            this._loadDataFunction = loadText;
        }

/*
        if (!trailingSlashRegex.test(url)) {
            url = url + '/';
        }
*/

        this._url = url;
        this._proxy = options.proxy;
        this._heightPower = defaultValue(options.heightPower , 1);

        this._tilingScheme = new WebMercatorTilingScheme({numberOfLevelZeroTilesX:2});

        this._heightmapWidth = 32;
        this._demDataWidth   = 256;

        this._terrainDataStructure = {
            heightScale:       1,
            heightOffset:      0,
            elementsPerHeight: 1,
            stride:            1,
            elementMultiplier: 256
        };

        this._levelZeroMaximumGeometricError = TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(this._tilingScheme.ellipsoid, this._heightmapWidth, this._tilingScheme.getNumberOfXTilesAtLevel(0));

        this._errorEvent = new Event();

        var credit = defaultValue(options.credit, defaultCredit);
        if (typeof credit === 'string') {
            credit = new Credit(credit);
        }
        this._credit = credit;
    };

    JapanGSITerrainProvider.prototype.requestTileGeometry = function(x, y, level, throttleRequests) {
        var usePngData = this._usePngData;
        var orgx = x;
        var orgy = y;
        var shift = 0;
        if (level > GSI_MAX_TERRAIN_LEVEL) {
            shift = level - GSI_MAX_TERRAIN_LEVEL;
            level = GSI_MAX_TERRAIN_LEVEL;
        }

        x >>= shift+1;
        y >>= shift;
        var shiftx = (orgx % Math.pow(2, shift + 1)) / Math.pow(2, shift + 1);
        var shifty = (orgy % Math.pow(2, shift)) / Math.pow(2, shift);

        var url;
        if ( usePngData ){
            url = this._url + (level == 15 ? '5a' : '') +
                '/' + level + '/' + x + '/' + y + '.png';
        } else {
            url = this._url + (level == 15 ? '5a' : '') +
                '/' + level + '/' + x + '/' + y + '.txt';
        }

        var proxy = this._proxy;
        if (defined(proxy)) {
            url = proxy.getURL(url);
        }

        var promise;

        throttleRequests = defaultValue(throttleRequests, true);
        if ( throttleRequestByServer ){ // Patch for > CESIUM1.35
            if (throttleRequests) {
                promise = throttleRequestByServer(url, this._loadDataFunction);
                if (!defined(promise)) {
                    return undefined;
                }
            } else {
                promise = this._loadDataFunction(url);
            }
        } else {
            promise = this._loadDataFunction(url, null, new Cesium.Request({throttle:true}));
        }

        var self = this;
        return when(promise, function(data) {
            var heightCSV = [];
            var heights = [];
            if ( usePngData ){
                var canvas = document.createElement("canvas");
                canvas.width  = "256";
                canvas.height = "256";
                var cContext = canvas.getContext('2d');
                cContext.mozImageSmoothingEnabled = false;
                cContext.webkitImageSmoothingEnabled = false;
                cContext.msImageSmoothingEnabled = false;
                cContext.imageSmoothingEnabled = false;
                cContext.drawImage(data, 0, 0);
                var pixData = cContext.getImageData(0, 0, 256, 256).data;
                var alt;
                for ( var y = 0 ; y < 256 ; y++ ){
                    heights = [];
                    for ( var x = 0 ; x < 256 ; x++ ){
                        var addr = ( x + y * 256 ) * 4;
                        var R = pixData[ addr ];
                        var G = pixData[ addr + 1 ];
                        var B = pixData[ addr + 2 ];
                        var A = pixData[ addr + 3 ];
                        if ( R == 128 && G == 0 && B == 0 ){
                            alt = 0;
                        } else {
//                          alt = (R << 16 + G << 8 + B);
                            alt = (R * 65536 + G * 256 + B);
                            if ( alt > 8388608 ){
                                alt = ( alt - 16777216 );
                            }
                            alt = alt * 0.01;
                        }
                        heights.push(alt);
                    }
                    heightCSV.push(heights);
                }
            } else {
                var LF = String.fromCharCode(10);
                var lines = data.split(LF);
                for (var i=0; i<lines.length; i++){
                    heights = lines[i].split(",");
                    for (var j=0; j<heights.length; j++){
                        if (heights[j] == "e") heights[j] = 0;
                    }
                    heightCSV[i] = heights;
                }
            }

            var whm = self._heightmapWidth;
            var wim = self._demDataWidth;
            var hmp = new Int16Array(whm*whm);

            for(var y = 0; y < whm; ++y){
                for(var x = 0; x < whm; ++x){
                    var py = Math.round( ( y / Math.pow(2, shift) / ( whm - 1 ) + shifty ) * ( wim - 1 ) );
                    var px = Math.round( ( x / Math.pow(2, shift + 1) / ( whm - 1 ) + shiftx ) * ( wim - 1 ) );

                    hmp[y*whm + x] = Math.round(heightCSV[py][px] * self._heightPower);
                }
            }

            return new HeightmapTerrainData({
                buffer:        hmp,
                width:         self._heightmapWidth,
                height:        self._heightmapWidth,
                structure:     self._terrainDataStructure,
                childTileMask: GSI_MAX_TERRAIN_LEVEL
            });
        });
    };

    JapanGSITerrainProvider.prototype.getLevelMaximumGeometricError = function(level) {
        return this._levelZeroMaximumGeometricError / (1 << level);
    };
    JapanGSITerrainProvider.prototype.hasWaterMask = function() {
        return !true;
    };
    JapanGSITerrainProvider.prototype.getTileDataAvailable = function(x, y, level) {
        return true;
    };

    defineProperties(JapanGSITerrainProvider.prototype, {
        errorEvent : {
            get : function() {
                return this._errorEvent;
            }
        },

        credit : {
            get : function() {
                return this._credit;
            }
        },

        tilingScheme : {
            get : function() {
                return this._tilingScheme;
            }
        },

        ready : {
            get : function() {
                return true;
            }
        }
    });

    Cesium.JapanGSITerrainProvider = JapanGSITerrainProvider;
})();
  </script>
<script>

    var camera_start = Cesium.Cartesian3.fromDegrees(135.0, 35.0, 1000);
    var camera_direction = Cesium.Cartesian3.fromDegrees(-75.0, 70.0, 0);

    var viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: new Cesium.JapanGSIImageryProvider({
            layerLists: ["ort","relief","std"]
        }),
        terrainProvider: new Cesium.JapanGSITerrainProvider({
        }),
        baseLayerPicker: false,
        mapProjection: new Cesium.WebMercatorProjection(Cesium.Ellipsoid.WGS84)
    });
    var scene = viewer.scene;
    scene.globe.depthTestAgainstTerrain = true;
    scene.camera.lookAt(camera_start, camera_direction, Cesium.Cartesian3.UNIT_Z);

</script>
</body>
</html>
